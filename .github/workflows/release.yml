name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      # -------------------------
      # Build + sign + package (Linux)
      # -------------------------
      - name: Build Linux amd64
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          set -euo pipefail
          mkdir -p dist/linux
          go build -trimpath -ldflags "-s -w" -o dist/linux/catmint

      - name: Linux checksum + sign (keyless) + README.txt
        run: |
          set -euo pipefail

          # checksum file in folder linux
          (cd dist/linux && sha256sum catmint > checksum-sha256.txt)

          # sign checksum and upload to Rekor; keep bundle (contains tlog logIndex)
          cosign sign-blob --yes \
            --bundle dist/linux/checksum-sha256.txt.bundle \
            dist/linux/checksum-sha256.txt

          # extract logIndex for online verification link
          LINUX_LOGINDEX="$(jq -r '.verificationMaterial.tlogEntries[0].logIndex' dist/linux/checksum-sha256.txt.bundle)"
          echo "LINUX_LOGINDEX=$LINUX_LOGINDEX" >> "$GITHUB_ENV"

          # plain-text README for Notepad-friendly viewing
          cat > dist/linux/README.txt << EOF
          catmint – Installation & Verification Guide (Linux)

          INSTALLATION
          1. Pindahkan file "catmint" ke folder yang ada di PATH, contoh:
             /usr/local/bin

          2. Pastikan file bisa dieksekusi (command chmod +x catmint)

          3. Buka terminal baru dan jalankan:
             catmint --help

          Jika perintah tersebut berjalan, instalasi berhasil.

          VERIFICATION (ONLINE)
          catmint pada release ini ditandatangani secara cryptographic dan dicatat ke Sigstore Transparency Log (Rekor).
          Verifikasi dilakukan secara online menggunakan browser, berdasarkan logIndex.

          Link verifikasi (Sigstore Rekor Search):
          https://search.sigstore.dev/?logIndex=${LINUX_LOGINDEX}

          Cara cek:
          1. Buka link di atas.
          2. Pastikan entry menunjukkan artefak yang ditandatangani oleh GitHub Actions dari repository ini.

          File dalam paket ini:
          - catmint
          - checksum-sha256.txt
          - checksum-sha256.txt.bundle
          - README.txt
          EOF

      - name: Package Linux folder (tar.gz)
        run: |
          set -euo pipefail
          tar -C dist -czf dist/catmint-linux-amd64.tar.gz linux

      # -------------------------
      # Build + sign + package (Windows)
      # -------------------------
      - name: Build Windows amd64
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          set -euo pipefail
          mkdir -p dist/windows
          go build -trimpath -ldflags "-s -w" -o dist/windows/catmint.exe

      - name: Windows checksum + sign (keyless) + README.txt
        run: |
          set -euo pipefail

          (cd dist/windows && sha256sum catmint.exe > checksum-sha256.txt)

          cosign sign-blob --yes \
            --bundle dist/windows/checksum-sha256.txt.bundle \
            dist/windows/checksum-sha256.txt

          WINDOWS_LOGINDEX="$(jq -r '.verificationMaterial.tlogEntries[0].logIndex' dist/windows/checksum-sha256.txt.bundle)"
          echo "WINDOWS_LOGINDEX=$WINDOWS_LOGINDEX" >> "$GITHUB_ENV"

          cat > dist/windows/README.txt << EOF
          catmint – Installation & Verification Guide (Windows)

          INSTALLATION
          1. Buat folder, contoh:
             C:\catmint\

          2. Pindahkan file "catmint.exe" ke folder tersebut.

          3. Tambahkan folder C:\catmint ke Environment Variable (PATH).

          4. Tutup dan buka kembali Command Prompt atau PowerShell.

          5. Jalankan:
             catmint --help

          Jika perintah tersebut berjalan, instalasi berhasil.

          VERIFICATION (ONLINE)
          catmint pada release ini ditandatangani secara cryptographic dan dicatat ke Sigstore Transparency Log (Rekor).
          Verifikasi dilakukan secara online menggunakan browser, berdasarkan logIndex.

          Link verifikasi (Sigstore Rekor Search):
          https://search.sigstore.dev/?logIndex=${WINDOWS_LOGINDEX}

          Cara cek:
          1. Buka link di atas.
          2. Pastikan entry menunjukkan artefak yang ditandatangani oleh GitHub Actions dari repository ini.

          File dalam paket ini:
          - catmint.exe
          - checksum-sha256.txt
          - checksum-sha256.txt.bundle
          - README.txt
          EOF

      - name: Package Windows folder (zip)
        run: |
          set -euo pipefail
          (cd dist && zip -r catmint-windows-amd64.zip windows)

      # -------------------------
      # Release Notes (first release)
      # -------------------------
      - name: Generate Release Notes (first release)
        run: |
          set -euo pipefail

          TAG_NAME="${GITHUB_REF_NAME}"

          cat > RELEASE_NOTES.txt << EOF
          catmint ${TAG_NAME} – Initial Release

          Ini adalah rilis pertama dari catmint.

          catmint adalah tool untuk generate dan memverifikasi hash (checksum) dengan fokus pada transparansi dan supply-chain security.

          Binary tersedia untuk:
          - Linux (amd64)
          - Windows (amd64)

          ONLINE VERIFICATION 
          Release ini ditandatangani secara keyless (GitHub Actions OIDC) dan dicatat ke Sigstore Rekor.
          Kamu bisa memverifikasi keaslian secara online menggunakan link berikut:

          Linux:
          https://search.sigstore.dev/?logIndex=${LINUX_LOGINDEX}

          Windows:
          https://search.sigstore.dev/?logIndex=${WINDOWS_LOGINDEX}

          Di halaman tersebut kamu bisa melihat informasi signing (waktu, hash, dan identitas workflow/repo).

          EOF

      # -------------------------
      # Create GitHub Release (only 2 assets)
      # -------------------------
      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.txt
          files: |
            dist/catmint-linux-amd64.tar.gz
            dist/catmint-windows-amd64.zip
